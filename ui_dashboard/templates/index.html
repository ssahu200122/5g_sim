<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>5G Network Simulation Dashboard</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            width: 90%;
            max-width: 1200px;
        }

        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Dashboard Section */
        .dashboard-panel {
            flex: 2;
        }

        .nf-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .nf-box {
            width: 100px;
            height: 60px;
            background-color: #e0e0e0;
            border: 2px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #666;
            border-radius: 5px;
        }

        .nf-active {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        /* Phone Simulator Section */
        .phone-panel {
            flex: 1;
            max-width: 350px;
            border: 4px solid #333;
            border-radius: 20px;
            padding: 15px;
        }

        .phone-screen {
            background: #f9f9f9;
            height: 400px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            font-size: 0.8em;
            text-align: right;
            margin-bottom: 10px;
            color: red;
        }

        .status-connected {
            color: green;
        }

        input,
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
        }

        .log-area {
            flex-grow: 1;
            background: #eee;
            font-family: monospace;
            font-size: 0.9em;
            padding: 5px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>5G Service-Based Architecture Simulation</h1>

    <div class="container">
        <div class="panel dashboard-panel">
            <h2>Core Network Status</h2>
            <p>Polling NRF for active functions...</p>
            <div class="nf-grid" id="nfContainer">
                <div class="nf-box">NRF</div>
                <div class="nf-box">AMF</div>
                <div class="nf-box">UDM</div>
                <div class="nf-box">AUSF</div>
                <div class="nf-box">SMF</div>
                <div class="nf-box">UPF</div>
            </div>
        </div>

        <div class="panel phone-panel">
            <div class="phone-screen">
                <div id="signalStatus" class="status-bar">No Signal (4G)</div>
                <h3>UE Simulator</h3>
                <input type="text" id="imsiInput" value="imsi-123456789" placeholder="Enter IMSI">
                <button id="connectBtn" onclick="connectToNetwork()">1. Connect to 5G</button>
                <button id="browseBtn" onclick="browseInternet()" disabled>2. Browse Internet (Video)</button>

                <label>Device Logs:</label>
                <div class="log-area" id="phoneLogs"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:8000/api";
        const logArea = document.getElementById('phoneLogs');
        const signalStatus = document.getElementById('signalStatus');
        const browseBtn = document.getElementById('browseBtn');
        const connectBtn = document.getElementById('connectBtn');

        // --- HELPER: Add message to Phone Log ---
        function addLog(msg, type = 'info') {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : '#333');
            div.style.marginBottom = "4px";
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight; // Auto-scroll to bottom
        }

        // --- FEATURE 1: Poll Network Status (The Dashboard) ---
        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE}/network-status`);
                if (response.status === 503) {
                    console.warn("Network is down");
                    return;
                }
                const nfs = await response.json();

                // Get all gray boxes
                const boxes = document.querySelectorAll('.nf-box');

                boxes.forEach(box => {
                    const nfName = box.textContent.trim();
                    // If this NF name exists in the API response, turn it green
                    if (nfs[nfName] && nfs[nfName].status === 'active') {
                        box.classList.add('nf-active');
                    } else {
                        box.classList.remove('nf-active');
                    }
                });
            } catch (err) {
                console.error("Dashboard update failed:", err);
            }
        }

        // Run dashboard update every 2 seconds
        setInterval(updateDashboard, 2000);
        updateDashboard(); // Run once immediately


        // --- FEATURE 2: Connect Button Logic ---
        async function connectToNetwork() {
            const imsi = document.getElementById('imsiInput').value;
            if (!imsi) { alert("Please enter an IMSI"); return; }

            addLog(`Searching for network (IMSI: ${imsi})...`);
            connectBtn.disabled = true; // Prevent double clicking

            try {
                const response = await fetch(`${API_BASE}/phone-connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imsi: imsi })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog("Authentication Successful!", "success");
                    addLog(`Assigned IP: ${data.ip_address}`, "success");
                    addLog("5G Core Connection Established.", "success");

                    // Update UI Status
                    signalStatus.textContent = "5G (Connected)";
                    signalStatus.classList.add("status-connected");

                    // Enable the next step
                    browseBtn.disabled = false;
                } else {
                    addLog(`Connection Failed: ${data.reason || 'Unknown Error'}`, "error");
                    connectBtn.disabled = false;
                }
            } catch (err) {
                addLog(`System Error: ${err}`, "error");
                connectBtn.disabled = false;
            }
        }


        // --- FEATURE 3: Browse Button Logic ---
        async function browseInternet() {
                addLog("Requesting 4K Video Stream from Internet...");

                // Capture start time
                const startTime = Date.now();

                try {
                    const response = await fetch(`${API_BASE}/phone-browse`);
                    const data = await response.json();

                    // Calculate total real-world time
                    const endTime = Date.now();
                    const totalTime = (endTime - startTime) / 1000;

                    if (response.ok) {
                        addLog(`Data Received via UPF!`, "success");
                        addLog(`Payload: "${data.internet_response.data}"`, "info");

                        // --- NEW: Show Physics Stats ---
                        addLog(`SPEED TEST RESULT:`, "info");
                        addLog(`- Latency: ${totalTime.toFixed(2)}s`, "info");
                        addLog(`- Jitter: Simulated`, "info");
                        // -------------------------------
                    } else {
                        addLog("Data Request Failed.", "error");
                    }
                } catch (err) {
                    addLog(`Browse Error: ${err}`, "error");
                }
            }
    </script>
</body>

</html>